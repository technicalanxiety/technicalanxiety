name: Publish Scheduled Posts (Astro)

# Runs daily at 9 AM UTC (adjust timezone as needed)
# Also allows manual triggering from Actions tab
on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  publish-posts:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          
      # Set up Git configuration for commits
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
      # Set up Node.js for Astro
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      # Run Python script to move posts from backlog and update series links
      - name: Publish scheduled posts and update series links
        run: |
          python3 << 'EOF'
          import os
          import re
          from datetime import datetime, timezone
          from pathlib import Path
          
          backlog_dir = Path('src/content/backlog')
          posts_dir = Path('src/content/posts')
          today = datetime.now(timezone.utc).date()
          published_posts = []
          updated_links = []
          
          if not backlog_dir.exists():
              print("No backlog directory found")
              exit(0)
          
          for post_file in backlog_dir.glob('*.md'):
              if post_file.name == '.gitkeep':
                  continue
                  
              content = post_file.read_text(encoding='utf-8')
              date_match = re.search(r'^date:\s*(\d{4}-\d{2}-\d{2})', content, re.MULTILINE)
              
              if date_match:
                  post_date_str = date_match.group(1)
                  post_date = datetime.strptime(post_date_str, '%Y-%m-%d').date()
                  
                  if post_date <= today:
                      destination = posts_dir / post_file.name
                      post_file.rename(destination)
                      published_posts.append(post_file.name)
                      print(f"Published: {post_file.name} (dated {post_date_str})")
                      
                      # Extract slug from filename (Astro uses filename as slug)
                      slug = post_file.stem  # filename without extension
                      title_match = re.search(r'^title:\s*["\']?(.+?)["\']?\s*$', content, re.MULTILINE)
                      title = title_match.group(1) if title_match else "Next Part"
                      
                      # Update series links in existing posts
                      for existing_post in posts_dir.glob('*.md'):
                          if existing_post.name == post_file.name:
                              continue
                          
                          existing_content = existing_post.read_text(encoding='utf-8')
                          placeholder_pattern = f'<!-- NEXT_PART: {post_file.name} -->.*?<!-- END_NEXT_PART -->'
                          
                          if re.search(placeholder_pattern, existing_content, re.DOTALL):
                              new_content = re.sub(
                                  placeholder_pattern,
                                  f'**Next in Series:** [{title} →](/{slug}/)',
                                  existing_content,
                                  flags=re.DOTALL
                              )
                              existing_post.write_text(new_content, encoding='utf-8')
                              updated_links.append(existing_post.name)
                              print(f"Updated series link in: {existing_post.name}")
          
          if published_posts:
              print(f"\n✓ Published {len(published_posts)} post(s)")
              if updated_links:
                  print(f"✓ Updated series links in {len(updated_links)} post(s)")
              exit(0)
          else:
              print("No posts ready to publish")
              exit(0)
          EOF
          
      # Install dependencies and build site if posts were published
      - name: Install dependencies and build
        if: success()
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "Posts were published, building site..."
            npm ci
            npm run build
          else
            echo "No posts published, skipping build"
          fi
          
      # Commit and push if there are changes
      - name: Commit and push changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add src/content/posts/ src/content/backlog/
            git commit -m "Auto-publish scheduled posts"
            git push
            echo "✓ Changes committed and pushed"
          else
            echo "No changes to commit"
          fi
