---
import { getCollection } from 'astro:content';
import TopologyGraph from '../components/TopologyGraph.astro';
import '../styles/topology.css';

// Pull all published posts
const allPosts = await getCollection('posts');

// Categorize posts into clusters based on tags
const categorizePost = (post) => {
  const tags = post.data.tags || [];
  const tagString = tags.join(' ').toLowerCase();
  
  // Mental Health cluster - 1982 Tron aesthetic
  if (tags.some(t => ['Anxiety', 'Leadership', 'Development'].includes(t)) && 
      tagString.includes('anxiety')) {
    return 'mentalHealth';
  }
  
  // Azure cluster - 2010 Tron Legacy aesthetic
  if (tags.some(t => ['Azure', 'Operations', 'Monitoring', 'Infrastructure', 'KQL'].includes(t))) {
    return 'azure';
  }
  
  // Leadership cluster - 2025 Tron Ares aesthetic
  if (tags.some(t => ['Leadership', 'Architecture', 'Governance', 'Platform'].includes(t))) {
    return 'leadership';
  }
  
  return 'leadership'; // default
};

// Build content graph
const contentGraph = {
  mentalHealth: [],
  azure: [],
  leadership: []
};

// Categorize all posts
allPosts.forEach(post => {
  const cluster = categorizePost(post);
  contentGraph[cluster].push({
    id: post.slug,
    title: post.data.title,
    date: post.data.date,
    tags: post.data.tags || [],
    series: post.data.series || null,
    seriesPart: post.data.series_part || null,
    description: post.data.description || '',
    url: `/${post.slug}/`
  });
});

// Sort each cluster by date (newest first)
Object.keys(contentGraph).forEach(cluster => {
  contentGraph[cluster].sort((a, b) => new Date(b.date) - new Date(a.date));
});

// Calculate gravity - which cluster has the most content?
const clusterCounts = {
  mentalHealth: contentGraph.mentalHealth.length,
  azure: contentGraph.azure.length,
  leadership: contentGraph.leadership.length
};

// Find the heaviest cluster
const heaviestCluster = Object.keys(clusterCounts).reduce((a, b) => 
  clusterCounts[a] > clusterCounts[b] ? a : b
);

const pageTitle = "Content Topology";
const pageDescription = "Explore the architecture of thought across Azure, Leadership, and Mental Health.";
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{pageTitle} | Technical Anxiety</title>
  <meta name="description" content={pageDescription}>
</head>
<body data-theme="dark">
  <div class="topology-container">
    <header class="topology-header">
      <h1>Content Topology</h1>
      <p class="subtitle">Mapping the architecture of thought</p>
      <div class="cluster-stats">
        <span class="stat mental-health">Mental Health: {clusterCounts.mentalHealth}</span>
        <span class="stat azure">Azure: {clusterCounts.azure}</span>
        <span class="stat leadership">Leadership: {clusterCounts.leadership}</span>
      </div>
    </header>

    <TopologyGraph 
      contentGraph={contentGraph} 
      heaviestCluster={heaviestCluster}
      clusterCounts={clusterCounts}
    />

    <!-- About/Explanation Section -->
    <div class="topology-about">
      <h2>The Architecture of Thought</h2>
      <p class="about-intro">This visualization maps how I think across three domains, each represented by a different era of Tron aesthetics:</p>
      
      <div class="domain-explanations">
        <div class="domain-card mental-health">
          <h3>Mental Health <span class="era">1982</span></h3>
          <p>Warm, human, analog. Where I started - the foundation of vulnerability and authentic experience. The poetry of code, debugging myself, the human cost of technical work.</p>
        </div>
        
        <div class="domain-card azure">
          <h3>Azure <span class="era">2010</span></h3>
          <p>Sleek, technical, professional. My domain expertise - cloud architecture, operations, governance, and infrastructure. The craft I've mastered.</p>
        </div>
        
        <div class="domain-card leadership">
          <h3>Leadership <span class="era">2025</span></h3>
          <p>Intense, evolved, rebellious. Where I'm pushing the frontier - architectural translation, decision frameworks, organizational transformation, and confidence engineering.</p>
        </div>
      </div>
      
      <div class="about-mechanics">
        <p><strong>The triangle tilts toward the cluster with the most content</strong> - showing where my focus has been.</p>
        <p><strong>Solid lines connect series parts</strong> - follow them to read multi-part explorations in order.</p>
        <p><strong>Dotted lines show thematic connections</strong> - articles that share ideas across domains.</p>
        <p><strong>Numbers on nodes indicate series parts</strong> - so you know where you are in a sequence.</p>
        <p><strong>The white center is me</strong> - at the intersection of all three domains.</p>
      </div>
    </div>

    <!-- Article Lists -->
    <div class="article-lists">
      <div class="article-column mental-health-column">
        <h3>Mental Health</h3>
        <ul>
          {contentGraph.mentalHealth.map(post => (
            <li>
              <a 
                href={post.url} 
                class="article-link"
                data-article-id={post.id}
              >
                {post.title}
                {post.series && post.seriesPart && (
                  <span class="series-badge">{post.series} #{post.seriesPart}</span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </div>

      <div class="article-column azure-column">
        <h3>Azure</h3>
        <ul>
          {contentGraph.azure.map(post => (
            <li>
              <a 
                href={post.url} 
                class="article-link"
                data-article-id={post.id}
              >
                {post.title}
                {post.series && post.seriesPart && (
                  <span class="series-badge">{post.series} #{post.seriesPart}</span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </div>

      <div class="article-column leadership-column">
        <h3>Leadership</h3>
        <ul>
          {contentGraph.leadership.map(post => (
            <li>
              <a 
                href={post.url} 
                class="article-link"
                data-article-id={post.id}
              >
                {post.title}
                {post.series && post.seriesPart && (
                  <span class="series-badge">{post.series} #{post.seriesPart}</span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>

    <nav class="topology-nav">
      <a href="/" class="back-link">‚Üê Back to Home</a>
    </nav>
  </div>

  <script src="../scripts/topology-engine.js"></script>
</body>
</html>
