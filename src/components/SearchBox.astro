---
// Search box component for the header
---

<div class="search-container">
  <form class="search-form" role="search">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search posts..."
      aria-label="Search posts"
      autocomplete="off"
    />
    <button type="submit" class="search-button" aria-label="Search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    </button>
  </form>
  
  <div id="search-results" class="search-results" style="display: none;">
    <div class="search-results-content">
      <div class="search-results-header">
        <span class="search-results-count"></span>
        <button id="search-close" class="search-close" aria-label="Close search">Ã—</button>
      </div>
      <div class="search-results-list"></div>
    </div>
  </div>
</div>

<script>
  import Fuse from 'fuse.js';

  interface SearchItem {
    id: string;
    title: string;
    description: string;
    content: string;
    tags: string[];
    date: string;
    url: string;
  }

  class SearchManager {
    private fuse: Fuse<SearchItem> | null = null;
    private searchInput: HTMLInputElement | null = null;
    private searchResults: HTMLElement | null = null;
    private searchResultsList: HTMLElement | null = null;
    private searchResultsCount: HTMLElement | null = null;
    private searchClose: HTMLElement | null = null;
    private searchIndex: SearchItem[] = [];

    constructor() {
      this.searchInput = document.getElementById('search-input') as HTMLInputElement;
      this.searchResults = document.getElementById('search-results');
      this.searchResultsList = document.querySelector('.search-results-list');
      this.searchResultsCount = document.querySelector('.search-results-count');
      this.searchClose = document.getElementById('search-close');

      this.init();
    }

    private async init() {
      await this.loadSearchIndex();
      this.setupEventListeners();
    }

    private async loadSearchIndex() {
      try {
        const response = await fetch('/search.json');
        this.searchIndex = await response.json();
        
        // Initialize Fuse.js with search options
        this.fuse = new Fuse(this.searchIndex, {
          keys: [
            { name: 'title', weight: 0.4 },
            { name: 'description', weight: 0.3 },
            { name: 'content', weight: 0.2 },
            { name: 'tags', weight: 0.1 }
          ],
          threshold: 0.3,
          includeScore: true,
          includeMatches: true,
          minMatchCharLength: 2,
        });
      } catch (error) {
        console.error('Failed to load search index:', error);
      }
    }

    private setupEventListeners() {
      // Search input events
      this.searchInput?.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.trim();
        if (query.length >= 2) {
          this.performSearch(query);
        } else {
          this.hideResults();
        }
      });

      // Form submission
      document.querySelector('.search-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = this.searchInput?.value.trim();
        if (query && query.length >= 2) {
          this.performSearch(query);
        }
      });

      // Close search results
      this.searchClose?.addEventListener('click', () => {
        this.hideResults();
        if (this.searchInput) {
          this.searchInput.value = '';
        }
      });

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.hideResults();
        }
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.searchResults?.contains(e.target as Node) && 
            !this.searchInput?.contains(e.target as Node)) {
          this.hideResults();
        }
      });
    }

    private performSearch(query: string) {
      if (!this.fuse) return;

      const results = this.fuse.search(query);
      this.displayResults(results, query);
    }

    private displayResults(results: import('fuse.js').FuseResult<SearchItem>[], query: string) {
      if (!this.searchResultsList || !this.searchResultsCount) return;

      // Update results count
      this.searchResultsCount.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"`;

      // Clear previous results
      this.searchResultsList.innerHTML = '';

      if (results.length === 0) {
        this.searchResultsList.innerHTML = `
          <div class="search-no-results">
            <p>No posts found for "${query}"</p>
            <p class="search-suggestion">Try different keywords or browse <a href="/archive/">all posts</a></p>
          </div>
        `;
      } else {
        // Display results (limit to 10)
        results.slice(0, 10).forEach(result => {
          const item = result.item;
          const resultElement = this.createResultElement(item, query);
          this.searchResultsList!.appendChild(resultElement);
        });
      }

      this.showResults();
    }

    private createResultElement(item: SearchItem, query: string): HTMLElement {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'search-result-item';

      // Format date
      const date = new Date(item.date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      // Create excerpt with highlighted search terms
      const excerpt = this.createExcerpt(item.content, query);

      resultDiv.innerHTML = `
        <a href="${item.url}" class="search-result-link">
          <div class="search-result-header">
            <h3 class="search-result-title">${this.highlightText(item.title, query)}</h3>
            <span class="search-result-date">${date}</span>
          </div>
          ${item.description ? `<p class="search-result-description">${this.highlightText(item.description, query)}</p>` : ''}
          <p class="search-result-excerpt">${excerpt}</p>
          ${item.tags.length > 0 ? `<div class="search-result-tags">${item.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
        </a>
      `;

      return resultDiv;
    }

    private createExcerpt(content: string, query: string, maxLength: number = 150): string {
      // Remove markdown and HTML
      const cleanContent = content.replace(/[#*`_\[\]()]/g, '').replace(/<[^>]*>/g, '');
      
      // Find the first occurrence of the search term
      const queryIndex = cleanContent.toLowerCase().indexOf(query.toLowerCase());
      
      if (queryIndex === -1) {
        // If query not found, return beginning of content
        return this.highlightText(cleanContent.substring(0, maxLength) + '...', query);
      }

      // Extract excerpt around the search term
      const start = Math.max(0, queryIndex - 50);
      const end = Math.min(cleanContent.length, start + maxLength);
      let excerpt = cleanContent.substring(start, end);

      if (start > 0) excerpt = '...' + excerpt;
      if (end < cleanContent.length) excerpt = excerpt + '...';

      return this.highlightText(excerpt, query);
    }

    private highlightText(text: string, query: string): string {
      if (!query) return text;
      
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    private showResults() {
      if (this.searchResults) {
        this.searchResults.style.display = 'block';
        // Add animation class after a brief delay
        setTimeout(() => {
          this.searchResults?.classList.add('search-results-visible');
        }, 10);
      }
    }

    private hideResults() {
      if (this.searchResults) {
        this.searchResults.classList.remove('search-results-visible');
        setTimeout(() => {
          if (this.searchResults) {
            this.searchResults.style.display = 'none';
          }
        }, 200);
      }
    }
  }

  // Initialize search when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new SearchManager();
  });
</script>

<style>
  .search-container {
    position: relative;
    width: 100%;
  }

  .search-form {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
  }

  .search-input {
    width: 100%;
    padding: 1rem;
    font-size: 1.125rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-sans);
    transition: all var(--transition-fast);
  }

  .search-input:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-color: var(--color-accent);
  }

  .search-input::placeholder {
    color: var(--text-secondary);
  }

  .search-button {
    position: absolute;
    right: 1rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color var(--transition-fast);
  }

  .search-button:hover {
    color: var(--color-accent);
  }

  .search-results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
    opacity: 0;
    transform: translateY(-10px);
    transition: all var(--transition-base);
    pointer-events: none;
  }

  .search-results-visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .search-results-content {
    padding: 1rem;
  }

  .search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
  }

  .search-results-count {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .search-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color var(--transition-fast);
  }

  .search-close:hover {
    color: var(--color-accent);
  }

  .search-result-item {
    margin-bottom: 0.75rem;
  }

  .search-result-item:last-child {
    margin-bottom: 0;
  }

  .search-result-link {
    display: block;
    padding: 0.875rem;
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: background-color var(--transition-fast);
    border: 1px solid transparent;
  }

  .search-result-link:hover {
    background: var(--bg-secondary);
    border-color: var(--border-color);
  }

  .search-result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
    gap: 1rem;
  }

  .search-result-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-heading);
    line-height: 1.3;
    flex: 1;
  }

  .search-result-date {
    font-size: 0.75rem;
    color: var(--text-secondary);
    flex-shrink: 0;
    font-weight: 500;
  }

  .search-result-description {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--text-primary);
    line-height: 1.5;
  }

  .search-result-excerpt {
    margin: 0 0 0.5rem 0;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .search-result-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .search-result-tags .tag {
    font-size: 0.6875rem;
    padding: 0.125rem 0.5rem;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: 9999px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all var(--transition-fast);
  }

  .search-result-tags .tag:hover {
    background: var(--color-accent);
    color: var(--bg-primary);
    border-color: var(--color-accent);
  }

  .search-no-results {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
  }

  .search-no-results p {
    margin: 0 0 0.5rem 0;
  }

  .search-suggestion {
    font-size: 0.875rem;
  }

  .search-suggestion a {
    color: var(--color-accent);
    text-decoration: underline;
    transition: color var(--transition-fast);
  }

  .search-suggestion a:hover {
    color: var(--link-hover);
  }

  /* Highlight search terms */
  mark {
    background: var(--color-accent);
    color: var(--bg-primary);
    padding: 0 0.25rem;
    border-radius: 2px;
    font-weight: 600;
  }

  /* Scrollbar styling */
  .search-results::-webkit-scrollbar {
    width: 8px;
  }

  .search-results::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
  }

  .search-results::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: var(--radius-md);
  }

  .search-results::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .search-results {
      max-height: 300px;
    }

    .search-result-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .search-result-date {
      margin-top: 0.25rem;
    }
  }
</style>