---
import { siteConfig } from '../config';
import { getPublishedPosts, getSeriesCollection } from '../utils/posts';
import Avatar from './Avatar.astro';

// Get series collection for sidebar
const seriesCollection = await getSeriesCollection();
const recentSeries = seriesCollection.slice(0, 5);

// Get all unique tags
const posts = await getPublishedPosts();
const allTags = [...new Set(posts.flatMap(post => post.data.tags || []))].sort();
---

<aside class="sidebar">
  <!-- Series Collection Widget -->
  <div class="widget">
    <h3 class="widget-title">Series Collection</h3>
    <div class="series-collection-list">
      {recentSeries.map((series) => (
        <article class="series-card">
          <a href={`/${series.firstPost.slug}/`} class="series-link">
            <div class="series-main">
              <div class="series-content">
                <h4 class="series-title">{series.name}</h4>
                <span class="series-badge">{series.posts.length} PART{series.posts.length !== 1 ? 'S' : ''}</span>
              </div>
              <div class="series-meta">
                <span class="series-arrow">Start Here</span>
              </div>
            </div>
          </a>
        </article>
      ))}
    </div>
  </div>

  <!-- Tags Widget -->
  <div class="widget">
    <h3 class="widget-title">Popular Tags</h3>
    <div class="tags-cloud">
      {allTags.slice(0, 12).map((tag) => (
        <a href={`/tags/${tag}/`} class="tag">{tag}</a>
      ))}
    </div>
  </div>

  <!-- Stay Connected Widget -->
  <div class="widget">
    <h3 class="widget-title">Stay Connected</h3>
    <p class="widget-description">Subscribe to get the latest posts delivered right to your feed.</p>
    <div class="connect-links">
      <a href="/rss.xml" class="connect-link" target="_blank" rel="noopener noreferrer" aria-label="Subscribe to RSS Feed">
        <ion-icon name="radio-outline"></ion-icon>
        <span>RSS Feed</span>
      </a>
    </div>
  </div>

</aside>

<style>
  .author-bio {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .author-avatar {
    margin: 0 auto var(--space-md);
    display: block;
    box-shadow: var(--shadow);
  }

  .author-name {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: var(--space-md);
    margin-bottom: var(--space-sm);
    color: var(--text-heading);
  }

  .author-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--space-md);
  }

  .social-links {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .social-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  /* Light mode styling for social links */
  [data-theme="light"] .social-link {
    background: #f8f9fa;
    border: 2px solid #e1e4e8;
  }

  .social-link:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.25);
  }

  .social-link ion-icon {
    font-size: 1.25rem;
  }

  .connect-links {
    display: flex;
    justify-content: center;
    margin-top: var(--space-md);
  }

  .connect-link {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    transition: all var(--transition-fast);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Light mode styling for connect links */
  [data-theme="light"] .connect-link {
    background: #f8f9fa;
    border: 2px solid #e1e4e8;
  }

  .connect-link:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.25);
  }

  .connect-link ion-icon {
    font-size: 1.125rem;
  }

  .recent-posts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .recent-post {
    display: flex;
    gap: var(--space-sm);
    align-items: flex-start;
  }

  .recent-image {
    width: 60px;
    height: 60px;
    background-size: cover;
    background-position: center;
    border-radius: var(--radius-md);
    flex-shrink: 0;
  }

  .recent-content {
    flex: 1;
    min-width: 0;
  }

  .recent-title {
    font-size: 0.875rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: var(--space-xs);
  }

  .recent-title a {
    color: var(--text-primary);
    transition: color var(--transition-fast);
  }

  .recent-title a:hover {
    color: var(--color-accent);
  }

  .recent-date {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  /* Series Collection Styles */
  .series-collection-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .series-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    transition: transform var(--transition-base), box-shadow var(--transition-base);
  }

  .series-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 32px 0 rgba(33, 150, 243, 0.25);
  }

  /* Light mode styling for series cards */
  [data-theme="light"] .series-card {
    background: var(--bg-secondary);
  }

  .series-link {
    display: block;
    padding: var(--space-sm) var(--space-lg);
    text-decoration: none;
    color: inherit;
    height: 100%;
  }

  .series-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-md);
  }

  .series-content {
    flex: 1;
    min-width: 0;
  }

  .series-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.1;
    color: var(--text-primary);
    margin: 0 0 2px 0;
  }

  .series-badge {
    background: transparent;
    color: var(--accent-color);
    border: 1.5px solid var(--accent-color);
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    padding: 1px 4px;
    border-radius: 6px;
    white-space: nowrap;
    display: inline-block;
    transition: all 0.2s ease;
    line-height: 1;
  }

  .series-card:hover .series-badge {
    background: var(--accent-color);
    color: white;
  }

  /* Different badge colors based on series length - outline approach */
  .series-card:nth-child(1) .series-badge {
    color: var(--accent-color);
    border-color: var(--accent-color);
  }

  .series-card:nth-child(1):hover .series-badge {
    background: var(--accent-color);
    color: white;
  }

  .series-card:nth-child(2) .series-badge {
    color: #5a67d8;
    border-color: #5a67d8;
  }

  .series-card:nth-child(2):hover .series-badge {
    background: #5a67d8;
    color: white;
  }

  .series-card:nth-child(3) .series-badge {
    color: #4299e1;
    border-color: #4299e1;
  }

  .series-card:nth-child(3):hover .series-badge {
    background: #4299e1;
    color: white;
  }

  .series-card:nth-child(4) .series-badge {
    color: #38b2ac;
    border-color: #38b2ac;
  }

  .series-card:nth-child(4):hover .series-badge {
    background: #38b2ac;
    color: white;
  }

  .series-card:nth-child(5) .series-badge {
    color: #805ad5;
    border-color: #805ad5;
  }

  .series-card:nth-child(5):hover .series-badge {
    background: #805ad5;
    color: white;
  }

  .series-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.75rem;
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .series-date {
    font-weight: 500;
  }

  .series-arrow {
    font-size: 1rem;
    color: var(--accent-color);
    transition: transform 0.2s ease;
  }

  .series-card:hover .series-arrow {
    transform: translateX(4px);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .series-link {
      padding: var(--space-sm) var(--space-md);
    }
    
    .series-main {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-sm);
    }
    
    .series-meta {
      align-self: stretch;
      justify-content: space-between;
    }
  }

  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .widget-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--space-md);
  }
</style>